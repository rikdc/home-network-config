---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: wildcard-home-claydon-co-tls
  namespace: ssl-certificates
  annotations:
    argocd.argoproj.io/sync-wave: "-2"
spec:
  refreshInterval: "720h"   # 30 days - certificates are valid for 1 year
  secretStoreRef:
    name: vault-k8s-auth
    kind: ClusterSecretStore
  target:
    name: wildcard-home-claydon-co-tls
    template:
      type: kubernetes.io/tls
      engineVersion: v2
      data:
        tls.key: "{{ .private_key }}"
        tls.crt: |
          {{- $leaf := .certificate -}}
          {{- $chain := .ca_chain | join "\n" -}}
          {{ printf "%s\n%s\n" $leaf $chain }}
  dataFrom:
    - sourceRef:
      generatorRef:
        apiVersion: generators.external-secrets.io/v1alpha1
        kind: VaultDynamicSecret
        name: wildcard-home-claydon-co
