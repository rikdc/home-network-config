---
# Storage configuration for Docmost
storage:
  pv:
    name: docmost-data-pv
    labels:
      type: data
      app: docmost
    capacity: 10Gi
    accessModes: ReadWriteMany
    reclaimPolicy: Retain
    storageClassName: nfs-storage
    nfs:
      server: nas.home.lan
      path: /volume1/docker/docmost
  pvc:
    name: docmost-data-pv-pvc
    namespace: tools
    accessModes: ReadWriteMany
    requests:
      storage: 10Gi
    storageClassName: nfs-storage

# External secrets configuration
externalSecret:
  name: docmost-external-secret
  namespace: tools
  refreshInterval: "15s"
  secretStoreRef:
    name: vault-kv
    kind: ClusterSecretStore
  target:
    name: app-secrets
  data:
    - secretKey: DATABASE_URL
      remoteRef:
        key: docmost
        property: DATABASE_URL
    - secretKey: APP_SECRET
      remoteRef:
        key: docmost
        property: APP_SECRET

# App template configuration for Docmost
app-template:
  namespaceOverride: tools

  controllers:
    docmost:
      type: deployment
      replicas: 1

      containers:
        app:
          image:
            repository: docmost/docmost
            tag: latest
            pullPolicy: IfNotPresent

          env:
            NODE_ENV: production
            PORT: "3000"
            TZ: America/New_York
            REDIS_URL: redis://localhost:6379
            DATABASE_URL:
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: DATABASE_URL
            APP_SECRET:
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: APP_SECRET

          ports:
            - name: http
              containerPort: 3000

          resources:
            limits:
              cpu: 1000m
              memory: 1Gi
            requests:
              cpu: 500m
              memory: 500Mi

          probes:
            liveness:
              enabled: true
              type: HTTP
              path: /
              port: 3000
              spec:
                initialDelaySeconds: 30
                timeoutSeconds: 5
                periodSeconds: 10
            readiness:
              enabled: true
              type: HTTP
              path: /
              port: 3000
              spec:
                initialDelaySeconds: 5
                timeoutSeconds: 3
                periodSeconds: 5

        redis:
          image:
            repository: redis
            tag: 7-alpine

          ports:
            - name: redis
              containerPort: 6379

          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 100m
              memory: 128Mi

          probes:
            liveness:
              enabled: true
              type: TCP
              port: 6379
              spec:
                initialDelaySeconds: 10
                periodSeconds: 10
            readiness:
              enabled: true
              type: TCP
              port: 6379
              spec:
                initialDelaySeconds: 5
                periodSeconds: 5

  persistence:
    data:
      existingClaim: docmost-data-pv-pvc
      globalMounts:
        - path: /app/data

    redis-data:
      type: emptyDir
      globalMounts:
        - path: /data

  service:
    docmost:
      controller: docmost
      ports:
        http:
          port: 3000

  ingress:
    docmost:
      enabled: true
      className: traefik
      annotations:
        traefik.ingress.kubernetes.io/router.entrypoints: web, websecure
      hosts:
        - host: wiki.home.claydon.co
          paths:
            - path: /
              pathType: Prefix
              service:
                identifier: docmost
                port: http
      tls:
        - secretName: wildcard-home-claydon-co-tls
          hosts:
            - wiki.home.claydon.co
